<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Agriculture App</title>
    
    <base href="/" />
    
    <meta name="color-scheme" content="light dark" />
    <meta
      name="viewport"
      content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    
    <link rel="manifest" href="/manifest.json" />
    
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />
    
    <!-- add to homescreen for ios -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Ionic App" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  </head>
  <body>
    
    <div id="marker"></div>
    <button id="closecam" autoplay>CLOSE</button>
    <video id="vid"></video>
    <div id="frstpgtitle" class="title">Your Location</div>
    <div id="scndpgtitle" class="title">Field details</div>
    <div class="page" id="firstpg"></div>
    <div class="page" id="secondpg"></div>
    <div class="page" id="thirdpg">
      <button class="dashboardbut" id="overview">GPSdata</button>
      <button class="dashboardbut" id="detailed">Detailed</button>
      <textarea id="responseTextarea" cols="40" rows="10"></textarea>
      <p id="ar">Area</p>
      <table id="tbl">
        <tr>
          <th>Latitude</th>
          <th>Longitude</th>
        </tr>
      </table>
    </div>
    <div id="empty"></div>
    <div id="footer">Dashboard</div>
    <div id="root"></div>
    <textarea id="state" class="inputtop" cols="20" rows="2">Enter state</textarea>
    <textarea id="district" class="inputmid" cols="20" rows="2">Enter district</textarea>
    <textarea id="profilename" class="inputmid" cols="20" rows="2">Enter profile name</textarea>
    <textarea id="enterarea" class="inputtop" cols="20" rows="2">Enter area</textarea>
    

    <div id="state" class="inputmid" class="or">or</div>
    <div id="or2" class="inputmid" class="or">or</div>
    <button id="calarea" class="inputmid" autoplay>Map your field</button>
    <button id="getloc" class="inputmid">get location</button>
    <button id="markcoord">START</button>
    <button id="next" class="inputmid">Next</button>
    <!-- <button id="previous" class="inputmid">Previous</button> -->
    <button id="next2" class="inputmid">Next</button>
    <button id="previous2" class="inputmid">Previous</button>
    <div id="canvpreview">Preview:-</div>
    <canvas id="myCanvas"></canvas>
    <div id="profileicon"></div>
    <div id="popup">
      <button id="newbut">New profile</button>
    </div>
    
  <style>
    body{
      background-color: greenyellow;
      scroll-snap-type: mandatory;
      overflow: hidden;
    }

    #ar{
      position: absolute;
      bottom: 2%;
      left: 30%;
      font-size: larger;
    }

    html{
      scroll-snap-type: mandatory;
      scroll-behavior: smooth;
    }

    #tbl{
      position: relative;
      top: 65%;
      width: 100%;
      text-align: center;
    }

    td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

    #profileicon{
      position: absolute;
      top: 2%;
      left: 285%;
      width: 10%;
      aspect-ratio: 1/1;
      background-color: gainsboro;
      background-image: url(https://png.pngtree.com/png-clipart/20200224/original/pngtree-avatar-icon-profile-icon-member-login-vector-isolated-png-image_5247852.jpg);
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      border-radius: 50px;
    }

    #popup{
      position: absolute;
      bottom: 0%;
      height: 60%;
      width: 100%;
      background-color: whitesmoke;
      border-radius: 2%;
      left: 200%;
    }

    #newbut{
      position: relative;
      width: 25%;
      top: 60%;
      left: 37%;
      aspect-ratio: 2/1;
      background-color: green;
      color: aliceblue;
      font-size: larger;
      border-radius: 30px;
    }

    #next {
      top: 70%;
      left: 53%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +10;
    }

    #previous {
      top: 50%;
      left: 13%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +10;
    }

    #next2 {
      top: 25%;
      left: 153%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +1;
    }

    #previous2 {
      top: 25%;
      left: 113%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +1;
    }

    .or{
      color: black;
      font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
      border-radius: 0%;
      position: absolute;
      top: 30%;
      resize: none;
      font-size: xx-large;
      overflow: hidden;
      height: 4%;
    }

    video {
        position: absolute;
        left: 103%;
        top: 2%;
        width: 94%;
        height: 0%;
        object-fit: cover;
        z-index: +2;
        
    }

    #myCanvas{
      position: absolute;
      bottom: 7%;
      height: 50%;
      /*height: 500px;*/
      width: 94%;
      /*width: 500px;*/
      background-color: white;
      border-style: solid;
      border-width: 1px;
      left: 103%;
    }

    #closecam {
      position: absolute;
        left: 105%;
        bottom: 10%;
        width: 15%;
        aspect-ratio: 1/1;
        object-fit: cover;
        z-index: +3;
        border-radius: 100px;
        background-color: red;
        font-weight:800;
        /* display: hidden; */
    }

    #markcoord {
      position: absolute;
        left: 140%;
        bottom: 10%;
        width: 15%;
        aspect-ratio: 1/1;
        font-size: small;
        text-align: center;
        object-fit: cover;
        z-index: +3;
        border-radius: 100px;
        background-color: green;
        /* display: hidden; */
    }

    #frstpgtitle{
           left: 4%;
           color: black;
           font-family: 'Courier New', Courier, monospace;
    }

    #scndpgtitle{
           left: 104%;
           width: 50%;
           color: black;

    }

    .title{
      font-size: xx-large;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      position: absolute;
      top: 3%;
      z-index: +1;
    }

    #area{
      left: 108%;
    }

    #calarea{
      left: 123%;
      width: 50%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      top: 17%;
    }

    #or2{
      position: absolute;
      left: 110%;
      top: 17%;
    }

    #enterarea{
      left: 113%;
      top: 10%;
    }

    #canvpreview{
      position: absolute;
      left: 103%;
      top: 39%;
      font-size: xx-large;
    }
    
    #getloc{
      left: 28%;
      width: 40%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
    }

    #prvcrops{
      top: 40%;
      left: 108%;
    }

    .inputtop{
      background-color: white;
      position: absolute;
      top: 20%;
      resize: none;
      font-size: xx-large;
      overflow: hidden;
      height: 4%;
      border-radius: 30px;
      color: black;
    }

    .inputmid{
      background-color: white;
      position: absolute;
      top: 30%;
      resize: none;
      font-size: xx-large;
      overflow: hidden;
      height: 4%;
      border-radius: 30px;
      color: black;
    }

    #responseTextarea{
      position: relative;
      top: 10%;
      left: 0%;
      height: 85%;
      width: 99%;
      font-size: xx-large;
      resize: none;
      color: black;
      background-color: white;
    }

    #profilename{
      left: 8%;
      top: 60%;
    }

    #state{
      left: 8%;

    }

    #district{
      left: 8%;
      top: 40%;
    }

    #empty{
      position: absolute;
      left: 0%;
      bottom: 0%;
      width: 300%;
      height: 1px;
    }

    #footer{
      position: absolute;
      top: 0%;
      left: 200%;
      width: 100%;
      height: 6%;
      background-color: green;
      color: white;
      font-size: xx-large;
      text-align: left;
      padding-top: 4%;
      padding-left: 3%;
    }

    #firstpg {
      left: 3%;
    }

    #secondpg {
      left: 103%;
    }

    #thirdpg {
      left: 203%;
    }

    .dashboardbut{
      position: relative;
      width: 25%;
      aspect-ratio: 2/1;
      top: 7%;
      left: 23%;
      border-top-right-radius: 10px;
      border-top-left-radius: 10px;
      background-color: white;
      font-size: larger;
      text-align: center;
      border-style: solid;
      color: black;
      
    }

    .page{
      position: absolute;
      top: 2%;
      height: 95%;
      width: 94%;
      background-color: white;
      border-radius: 2%;
      scroll-snap-align: center;

    }
  </style>
    <script type="module" src="/src/main.tsx"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/haversine-distance@1.2.1/index.min.js"></script> -->
<script type="module">
import API_KEY from "/apikey.js"


const asin = Math.asin
const cos = Math.cos
const sin = Math.sin
const sqrt = Math.sqrt
const PI = Math.PI

// equatorial mean radius of Earth (in meters)
const R = 6378137

function squared (x) { return x * x }
function toRad (x) { return x * PI / 180.0 }
function hav (x) {
  return squared(sin(x / 2))
}

// hav(theta) = hav(bLat - aLat) + cos(aLat) * cos(bLat) * hav(bLon - aLon)
function haversineDistance (a, b) {
  const aLat = toRad(Array.isArray(a) ? a[1] : a.latitude || a.lat)
  const bLat = toRad(Array.isArray(b) ? b[1] : b.latitude || b.lat)
  const aLng = toRad(Array.isArray(a) ? a[0] : a.longitude || a.lng || a.lon)
  const bLng = toRad(Array.isArray(b) ? b[0] : b.longitude || b.lng || b.lon)

  const ht = hav(bLat - aLat) + cos(aLat) * cos(bLat) * hav(bLng - aLng)
  return 2 * R * asin(sqrt(ht))
}

let state = document.getElementById("state")
let getloc = document.getElementById("getloc")
let district = document.getElementById("district")
let calarea = document.getElementById("calarea")
let closecam = document.getElementById("closecam")
let markcoord = document.getElementById("markcoord")
let sidelat = []
let sidelon = []
let noofside = 0
// let marker = document.getElementById("marker")
let myCanvas = document.getElementById("myCanvas")
var ctx = myCanvas.getContext("2d");
var startcounter = 0
let geodist

let xposend = Math.floor(sidelat[noofside])
let yposend = Math.floor(sidelon[noofside])
let xpos = Math.floor(sidelat[noofside-1])
let ypos = Math.floor(sidelon[noofside-1])
let debx = 19.075984
let deby = 72.877656
let debxend = 28.6097408
let debyend = 77.3685248
let nextcounter = 0
let scrolltarget = screen.width
let next = document.getElementById("next")
let previous2 = document.getElementById("previous2")
let next2 = document.getElementById("next2")
let id;
let cachelat;
let cachelon;
let cachelat2;
let cachelon2;
let delcachelat = cachelat2-cachelat;
let delcachelon = cachelon2-cachelon;
let popup = document.getElementById("popup")
let profileicon = document.getElementById("profileicon")
let newbut = document.getElementById('newbut')
let popupcount = 0;
let maxX;
let maxY;
let cachesidelat = []
let cachesidelon = []
let hope;
let responseTextarea = document.getElementById("responseTextarea")
let canvpreview = document.getElementById("canvpreview")
let permstate;
let permarea;
let headarr = []
let distarr = []
let area;
let overview = document.getElementById("overview")
let detailed = document.getElementById("detailed")
var table = document.getElementById("tbl");
let ar = document.getElementById("ar")
ar.style.display = "none"
detailed.addEventListener("click",()=>{
  myCanvas.style.display = "none"
  responseTextarea.style.display = "block"
  ar.style.display = "none"
})

overview.addEventListener("click",()=>{
  ar.style.display = "block"
  myCanvas.style.left = "203%"
  myCanvas.style.top = "15%"
  myCanvas.style.display = "block"
  responseTextarea.style.display = "none"
})

canvpreview.style.display = "none"
popup.style.display = "none"

newbut.addEventListener("click",()=>{
  window.scrollTo(0,0)
  nextcounter=0
  scrolltarget = screen.width
})

profileicon.addEventListener("click",()=>{
  popupcount++
  
  if(popupcount%2==0){
    popup.style.display = "none"
}
else{
    popup.style.display = "block"
}
})


next.addEventListener("click",()=>{

window.scrollTo(scrolltarget,0)
scrolltarget += screen.width
nextcounter+=1
console.log(nextcounter)
localStorage.setItem("state", state.innerHTML);
localStorage.setItem("district", district.innerHTML);
})

next2.addEventListener("click", async (e)=>{
e.preventDefault();


window.scrollTo(scrolltarget,0)
scrolltarget += screen.width
nextcounter+=1
console.log(nextcounter)
permstate = localStorage.getItem("state");
permarea = localStorage.getItem("area")
let mytext = "Give me an yearly planner for sowing crops in a"+" "+String(permarea)+" "+"metre square field in"+" "+permstate+" "+ "along with budget division among tools and crop seed price";

 if (mytext) {
        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`,
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [{ role: 'user', content: mytext }],
                    temperature: 1.0,
                    top_p: 0.7,
                    n: 1,
                    stream: false,
                    presence_penalty: 0,
                    frequency_penalty: 0,
                }),
            });

            if (response.ok) {
                const data = await response.json();
                responseTextarea.value = data.choices[0].message.content;
            } else {
                responseTextarea.value = 'Error: Unable to process your request.';
            }
        } catch (error) {
            console.error(error);
            responseTextarea.value = 'Error: Unable to process your request.';
        }
    }

})

previous2.addEventListener("click",()=>{

window.scrollTo(-scrolltarget,0)
scrolltarget -= screen.width
nextcounter-=1
console.log(nextcounter)
})


myCanvas.style.display = "none"
// marker.style.display = "none"
closecam.style.display = "none"
markcoord.style.display = "none"
getloc.addEventListener("click",() => {

    if(navigator.geolocation){
      navigator.geolocation.watchPosition(showLocation)
    }
    else{
      console.log("some issue was present")
    }
})

const showLocation = async (position) => {

          sidelat.push(position.coords.latitude)
          sidelon.push(position.coords.longitude)
          headarr.push(position.coords.heading)

  //We user the NOminatim API for getting actual addres from latitude and longitude
   let response = await fetch(
     `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
  );
  //store response object
  let data = await response.json();
  state.innerHTML = data.address.state
  district.innerHTML = data.address.state_district
  console.log(data.address)
  
};

function options (){
        enableHighAccuracy: true
        maximumAge: 1000;
        }

function error(err) {
        console.error(`ERROR(${err.code}): ${err.message}`);
        }


        calarea.addEventListener("click", () => {
          myCanvas.style.display = "block"
          // marker.style.display = "block"
          closecam.style.display = "block"
          markcoord.style.display = "block"
          canvpreview.style.display = "block"
        })
    
        closecam.addEventListener("click",()=>{
          closecam.style.display = "none"
          markcoord.style.display = "none"
          localStorage.setItem("area",area)
          // marker.style.display = "none"
          // navigator.geolocation.clearWatch(id);
        })

      markcoord.addEventListener("click",()=>{
          let xcan1;
          let ycan1;
          ctx.lineWidth = "2"
          ctx.strokeStyle = "black"
          
        if(markcoord.innerHTML == "START"){
          noofside++
          // console.log("noofside",noofside)
          if(noofside == 1){
            xcan1 = 7
            ycan1 = (myCanvas.height/2)+30
            
          }
          else{
            xcan1 = sidelat[sidelat.length-1]
            ycan1 = sidelon[sidelon.length-1]
          }
          // ctx.beginPath()
          // ctx.moveTo(debx,deby)
          // ctx.moveTo(xcan1,ycan1)
          cachelat = sidelat[sidelat.length-1]
          cachelon = sidelon[sidelon.length-1]
          console.log(cachelat,cachelon)
          // alert("switch off device's location and switch on again when reach the ending corner")
          markcoord.innerHTML = "STOP";
          var row = table.insertRow();
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          cell1.innerHTML = sidelat[sidelat.length-1];
          cell2.innerHTML = sidelon[sidelon.length-1];
        }
        else if (markcoord.innerHTML == "STOP") {
          cachelat2 = sidelat[sidelat.length-1]
          cachelon2 = sidelon[sidelon.length-1]

          console.log(cachelat2,cachelon2)
          // ctx.lineTo(sidelat[sidelat.length-1]*20,sidelon[sidelon.length-1]*20)
  
          console.log("noofside",noofside)
          console.log("stop ",sidelat[noofside], sidelon[noofside])
          console.log("stop ",sidelat,sidelon)
          // alert("stop "+String(sidelat[noofside])+" "+String(sidelon[noofside]))

          var row = table.insertRow();
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          cell1.innerHTML = sidelat[sidelat.length-1];
          cell2.innerHTML = sidelon[sidelon.length-1];

          
          let a = { latitude: cachelat, longitude: cachelon }
          let b = { latitude: cachelat2, longitude: cachelon2 }

          console.log(haversineDistance(a, b))
          alert("distance is "+String(haversineDistance(a, b))+" metres")
          markcoord.innerHTML = "START";

          distarr.push(haversineDistance(a,b))

          if(noofside == 2){
          // ctx.rect((myCanvas.width/2)-distarr[0]*0.00005, (myCanvas.height/3), distarr[0]*0.00005, distarr[1]*0.00005);
          ctx.rect((myCanvas.width/2)-distarr[0]*1.5, (myCanvas.height/3), distarr[0]*1.5, distarr[1]*1.5);
          area = distarr[0]*distarr[1]
          ar.innerHTML = "Area:-"+" "+String(area)
          }
        }
        ctx.stroke()

        startcounter++


      })

    </script>
  </body>
</html>
