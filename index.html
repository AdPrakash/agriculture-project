<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Agriculture App</title>
    
    <base href="/" />
    
    <meta name="color-scheme" content="light dark" />
    <meta
      name="viewport"
      content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    
    <link rel="manifest" href="/manifest.json" />
    
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />
    
    <!-- add to homescreen for ios -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Ionic App" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  </head>
  <body>
    
    <div id="marker"></div>
    <button id="closecam" autoplay></button>
    <video id="vid"></video>
    <div id="frstpgtitle" class="title">Your Location</div>
    <div id="scndpgtitle" class="title">Field details</div>
    <div class="page" id="firstpg"></div>
    <div class="page" id="secondpg"></div>
    <div class="page" id="thirdpg"></div>
    <div id="empty"></div>
    <div id="footer"></div>
    <div id="root"></div>
    <textarea id="state" class="inputtop" cols="20" rows="2">Enter state</textarea>
    <textarea id="district" class="inputmid" cols="20" rows="2">Enter district</textarea>
    <div id="state" class="inputmid" class="or">or</div>
    <button id="calarea" class="inputmid" autoplay>Map your field</button>
    <button id="getloc" class="inputmid">get location</button>
    <button id="markcoord">START</button>
    <button id="next" class="inputmid">Next</button>
    <!-- <button id="previous" class="inputmid">Previous</button> -->
    <button id="next2" class="inputmid">Next</button>
    <button id="previous2" class="inputmid">Previous</button>
    <canvas id="myCanvas"></canvas>
    
  <style>
    body{
      background-color: greenyellow;
      scroll-snap-type: mandatory;
      /* overflow: hidden; */
    }

    html{
      scroll-snap-type: mandatory;
      scroll-behavior: smooth;
    }

    #next {
      top: 50%;
      left: 53%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +10;
    }

    #previous {
      top: 50%;
      left: 13%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +10;
    }

    #next2 {
      top: 25%;
      left: 153%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +10;
    }

    #previous2 {
      top: 25%;
      left: 113%;
      width: 30%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      z-index: +10;
    }

    .or{
      color: black;
      font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
      border-radius: 0%;
      position: absolute;
      top: 30%;
      resize: none;
      font-size: xx-large;
      overflow: hidden;
      height: 4%;
    }

    video {
        position: absolute;
        left: 103%;
        top: 2%;
        width: 94%;
        height: 0%;
        object-fit: cover;
        z-index: +2;
        
    }

    #myCanvas{
      position: absolute;
      bottom: 7%;
      /* height: 70%; */
      height: 500px;
      /* width: 94%; */
      width: 500px;
      background-color: orange;
      left: 103%;
    }

    #closecam {
      position: absolute;
        left: 105%;
        bottom: 10%;
        width: 15%;
        aspect-ratio: 1/1;
        object-fit: cover;
        z-index: +3;
        border-radius: 100px;
        background-color: red;
        /* display: hidden; */
    }

    #marker{
      position: absolute;
        left: 145%;
        bottom: 20%;
        width: 7%;
        aspect-ratio: 1/1;
        z-index: 3;
        border-radius: 100px;
        background-color: yellow;
    }

    #markcoord {
      position: absolute;
        left: 140%;
        bottom: 10%;
        width: 15%;
        aspect-ratio: 1/1;
        font-size: small;
        text-align: center;
        object-fit: cover;
        z-index: +3;
        border-radius: 100px;
        background-color: green;
        /* display: hidden; */
    }

    #frstpgtitle{
           left: 4%;
           color: black;
           font-family: 'Courier New', Courier, monospace;
    }

    #scndpgtitle{
           left: 104%;
           width: 50%;
           color: black;

    }

    .title{
      font-size: xx-large;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      position: absolute;
      top: 3%;
      z-index: +1;
    }

    #area{
      left: 108%;
    }

    #calarea{
      left: 123%;
      width: 50%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
      top: 15%;
    }

    
    #getloc{
      left: 28%;
      width: 40%;
      height: 5%;
      font-size: larger;
      border-radius: 20px;
      background-color: greenyellow;
    }

    #prvcrops{
      top: 40%;
      left: 108%;
    }

    .inputtop{
      position: absolute;
      top: 20%;
      resize: none;
      font-size: xx-large;
      overflow: hidden;
      height: 4%;
      border-radius: 30px;
    }

    .inputmid{
      position: absolute;
      top: 30%;
      resize: none;
      font-size: xx-large;
      overflow: hidden;
      height: 4%;
      border-radius: 30px;
    }

    #state{
      left: 8%;

    }

    #district{
      left: 8%;
      top: 40%;
    }

    #empty{
      position: absolute;
      left: 0%;
      bottom: 0%;
      width: 300%;
      height: 1px;
    }

    #footer{
      position: fixed;
      bottom: 0%;
      left: 0%;
      width: 100%;
      height: 6%;
      background-color: green;
    }

    #firstpg {
      left: 3%;
    }

    #secondpg {
      left: 103%;
    }

    #thirdpg {
      left: 203%;
    }

    .page{
      position: absolute;
      top: 2%;
      height: 91%;
      width: 94%;
      background-color: white;
      border-radius: 2%;
      scroll-snap-align: center;

    }
  </style>
    <script type="module" src="/src/main.tsx"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initMap&v=weekly"
      defer
    ></script>
    <script>
let state = document.getElementById("state")
let getloc = document.getElementById("getloc")
let district = document.getElementById("district")
let calarea = document.getElementById("calarea")
let closecam = document.getElementById("closecam")
let markcoord = document.getElementById("markcoord")
let sidelat = []
let sidelon = []
let noofside = 0
let marker = document.getElementById("marker")
let myCanvas = document.getElementById("myCanvas")
var ctx = myCanvas.getContext("2d");
var startcounter = 0
let geodist
// let xpos = localStorage.getItem(String(noofside))
// let ypos = localStorage.getItem(String(noofside)+"lon")
// let xposend = localStorage.getItem(String(noofside)+"end")
// let yposend = localStorage.getItem(String(noofside)+"lon"+"end")
let xposend = Math.floor(sidelat[noofside])
let yposend = Math.floor(sidelon[noofside])
let xpos = Math.floor(sidelat[noofside-1])
let ypos = Math.floor(sidelon[noofside-1])
let debx = 19.075984
let deby = 72.877656
let debxend = 28.6097408
let debyend = 77.3685248
let nextcounter = 0
let scrolltarget = screen.width
let next = document.getElementById("next")
let previous2 = document.getElementById("previous2")
let next2 = document.getElementById("next2")

next.addEventListener("click",()=>{

window.scrollTo(scrolltarget,0)
scrolltarget += screen.width
nextcounter+=1
console.log(nextcounter)
})

next2.addEventListener("click",()=>{

window.scrollTo(scrolltarget,0)
scrolltarget += screen.width
nextcounter+=1
console.log(nextcounter)
})

previous2.addEventListener("click",()=>{

window.scrollTo(-scrolltarget,0)
scrolltarget -= screen.width
nextcounter-=1
console.log(nextcounter)
})


myCanvas.style.display = "none"
marker.style.display = "none"
closecam.style.display = "none"
markcoord.style.display = "none"
getloc.addEventListener("click",() => {

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(showLocation)
    }
    else{
      console.log("some issue was present")
    }
})

const showLocation = async (position) => {
  //We user the NOminatim API for getting actual addres from latitude and longitude
  let response = await fetch(
    `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
  );
  //store response object
  let data = await response.json();
  state.innerHTML = data.address.state
  district.innerHTML = data.address.state_district
  console.log(data.address)

};

let video = document.getElementById("vid");
        let mediaDevices = navigator.mediaDevices;
        vid.muted = true;
        calarea.addEventListener("click", () => {
          myCanvas.style.display = "block"
          marker.style.display = "block"
          closecam.style.display = "block"
          video.style.height = "91%"
          video.style.display = "block"
          markcoord.style.display = "block"
            // Accessing the user camera and video.
            mediaDevices
                .getUserMedia({
                    video: {
                      facingMode: 'environment'
                    },
                    audio: false,
                })
                .then((stream) => {
 
                    // Changing the source of video to current stream.
                    video.srcObject = stream;
                    video.addEventListener("loadedmetadata", () => {
                        video.play();
                    });
                })
                .catch(alert);
        });
    
        closecam.addEventListener("click",()=>{
          vid.muted = true
          video.srcObject = null
          video.style.height = "0%"
          video.style.display = "none"
          closecam.style.display = "none"
          markcoord.style.display = "none"
          marker.style.display = "none"
          // navigator.geolocation.clearWatch(id);
        })

      markcoord.addEventListener("click",()=>{
        navigator.geolocation.getCurrentPosition(storePosition, error, options);

        function storePosition(position){
          sidelat.push(position.coords.latitude)
          sidelon.push(position.coords.longitude)
        
          ctx.lineWidth = "2"
          ctx.strokeStyle = "black"
              
        if(markcoord.innerHTML == "START"){
          noofside++
          ctx.beginPath()
          // ctx.moveTo(debx,deby)
          ctx.moveTo(sidelat[noofside-1],sidelon[noofside-1])
          console.log("noofside",noofside)
          console.log("start ",sidelat[noofside-1],sidelon[noofside-1])
          alert("start "+String(sidelat[noofside-1])+" "+String(sidelon[noofside-1]))
          markcoord.innerHTML = "STOP";
        }
        else if (markcoord.innerHTML == "STOP") {
          
          // ctx.lineTo(debxend,debyend)
          ctx.lineTo(sidelat[noofside],sidelon[noofside])
          // debx+=5
          // deby+=5
          // debxend+=10
          // debyend+=10
          console.log("noofside",noofside)
          console.log("stop ",sidelat[noofside], sidelon[noofside])
          alert("stop "+String(sidelat[noofside])+" "+String(sidelon[noofside]))

          let a = Math.sin(((sidelat[noofside]-sidelat[noofside-1])*Math.PI/180)/2)*Math.sin(((sidelat[noofside]-sidelat[noofside-1])*Math.PI/180)/2)+Math.cos(sidelat[noofside]*Math.PI/180)*Math.cos(sidelat[noofside-1]*Math.PI/180)*Math.sin(((sidelon[noofside]-sidelon[noofside-1])*Math.PI/180)/2)*Math.sin(((sidelon[noofside]-sidelon[noofside-1])*Math.PI/180)/2);

          let c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))

          let d = 6371e3*c //in metres
          
          console.log(d)
          alert("distance is "+String(d)+" metres")
          markcoord.innerHTML = "START";
        }
        ctx.stroke()
        
        }
        // 
        startcounter++
        
    function options (){
    enableHighAccuracy: true
    // timeout: 5000
  // maximumAge: 0,
    }

function error(err) {
  console.error(`ERROR(${err.code}): ${err.message}`);
}

      })

// function storePosition(position){

// if(markcoord.innerHTML == "START"){
//   permlat = localStorage.setItem(String(noofside)+"end",position.coords.latitude)
//   permlon = localStorage.setItem(String(noofside)+"lon"+"end",position.coords.longitude)
// }
// else{
//   permlat = localStorage.setItem(String(noofside),position.coords.latitude)
//   permlon = localStorage.setItem(String(noofside)+"lon",position.coords.longitude)
// }
// }





    </script>
  </body>
</html>
